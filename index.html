<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoWeb3 Отзывы</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Leaflet.js (для OpenStreetMap) CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="" />
          
    <!-- 3. Leaflet.js (для OpenStreetMap) JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
            
    <!-- 4. Стили в духе Crypto.com (темная тема) -->
    <style>
        /* Используем шрифт Inter, как у многих крипто-сайтов */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c1029; /* Темно-синий фон */
        }
        
        /* Стилизация всплывающих окон Leaflet */
        .leaflet-popup-content-wrapper,
        .leaflet-popup-tip {
            background: #1a203c; /* Темный фон для popup */
            color: #f0f0f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        
        .leaflet-popup-content {
            margin: 14px 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .leaflet-container a.leaflet-popup-close-button {
            color: #a0aec0;
            padding: 8px 8px 0 0;
        }

        /* Кастомный скроллбар для панели отзывов */
        #reviewsList::-webkit-scrollbar {
            width: 6px;
        }
        #reviewsList::-webkit-scrollbar-track {
            background: #1a203c;
        }
        #reviewsList::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 3px;
        }
        
        /* Стилизация карты (темная тема) */
        .leaflet-tile-pane {
            /* Фильтр для инвертирования цветов карты */
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 overflow-hidden">

    <!-- Основной контейнер приложения -->
    <div id="app" class="relative h-screen w-screen">
    
        <!-- 1. Карта -->
        <div id="map" class="h-full w-full z-0"></div>

        <!-- 2. Хедер (Навигация) -->
        <header class="absolute top-0 left-0 w-full p-4 z-10 flex justify-between items-center bg-gray-900 bg-opacity-70 backdrop-blur-md shadow-lg">
            <h1 class="text-2xl font-bold text-white tracking-tight">
                Geo<span class="text-blue-400">Web3</span>
            </h1>
            <button id="connectButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-5 rounded-lg transition-all duration-200 shadow-md">
                Подключить MetaMask
            </button>
            <div id="walletInfo" class="hidden bg-gray-800 text-sm text-green-400 font-mono py-2 px-4 rounded-lg shadow-inner">
                <span id="networkName"></span>: <span id="walletAddress"></span>
            </div>
        </header>

        <!-- 3. Панель для отзывов и формы (скрыта по умолчанию) -->
        <div id="reviewPanel" class="absolute bottom-0 left-0 md:left-4 md:bottom-4 w-full md:w-[400px] h-3/4 md:h-[calc(100vh-8rem)] bg-gray-900 bg-opacity-80 backdrop-blur-lg shadow-2xl rounded-t-2xl md:rounded-2xl z-20 flex flex-col transform translate-y-full transition-transform duration-500 ease-in-out">
            
            <!-- Заголовок панели -->
            <div class="flex justify-between items-center p-4 border-b border-gray-700 flex-shrink-0">
                <div>
                    <h2 class="text-lg font-semibold text-white">Отзывы</h2>
                    <p id="locationIdDisplay" class="text-sm text-blue-300 font-mono"></p>
                </div>
                <button id="closePanelButton" class="text-gray-400 hover:text-white">&times;</button>
            </div>

            <!-- Табы (Просмотр / Добавить) -->
            <div class="flex border-b border-gray-700 flex-shrink-0">
                <button id="tabView" class="flex-1 py-3 text-sm font-medium text-white border-b-2 border-blue-500">Просмотр</button>
                <button id="tabAdd" class="flex-1 py-3 text-sm font-medium text-gray-400">Добавить отзыв</button>
            </div>

            <!-- Контент табов -->
            <div class="flex-1 overflow-y-auto">
                
                <!-- 3a. Список отзывов -->
                <div id="viewContent">
                    <div id="reviewsList" class="p-4 space-y-4 max-h-[calc(100vh-20rem)] overflow-y-auto">
                        <!-- Отзывы будут вставлены сюда -->
                        <p id="noReviewsMessage" class="text-gray-400 text-center py-8">Для этого места пока нет отзывов. Будьте первым!</p>
                    </div>
                    <div id="loadingIndicator" class="hidden text-center p-8">
                        <p class="text-blue-400">Загрузка отзывов из блокчейна...</p>
                    </div>
                </div>

                <!-- 3b. Форма добавления отзыва -->
                <div id="addContent" class="hidden p-4">
                    <form id="reviewForm" class="space-y-4">
                        <div>
                            <label for="institutionName" class="block text-sm font-medium text-gray-300 mb-1">Название учреждения</label>
                            <input type="text" id="institutionName" required class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Например, 'Кофейня'">
                        </div>
                        <div>
                            <label for="message" class="block text-sm font-medium text-gray-300 mb-1">Ваш отзыв</label>
                            <textarea id="message" rows="4" required class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Что вы думаете об этом месте?"></textarea>
                        </div>
                        <div>
                            <label for="rating" class="block text-sm font-medium text-gray-300 mb-1">Оценка (1-5)</label>
                            <select id="rating" required class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="5">★★★★★ (Отлично)</option>
                                <option value="4">★★★★☆ (Хорошо)</option>
                                <option value="3">★★★☆☆ (Средне)</option>
                                <option value="2">★★☆☆☆ (Плохо)</option>
                                <option value="1">★☆☆☆☆ (Ужасно)</option>
                            </select>
                        </div>
                        <button type="submit" id="submitReviewButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-5 rounded-lg transition-all duration-200 shadow-md disabled:opacity-50">
                            Отправить отзыв (потребует Gas)
                        </button>
                        <div id="txStatus" class="text-sm text-yellow-400 text-center hidden mt-2"></div>
                    </form>
                </div>

            </div>
        </div>
        
        <!-- Сообщение об ошибке (не та сеть) -->
        <div id="wrongNetworkBanner" class="hidden fixed bottom-4 right-4 bg-red-600 text-white p-4 rounded-lg shadow-lg z-30">
            <strong>Ошибка!</strong> Пожалуйста, переключитесь на сеть Sepolia в MetaMask.
        </div>

    </div>

    <!-- 5. JavaScript Приложения -->
    <script type="module">
        // 5a. Импорт Ethers.js
        // Ethers.js - это библиотека для взаимодействия с блокчейном Ethereum
        import { ethers } from "https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.1/ethers.umd.min.js";

        // -----------------------------------------------------------------
        // !! ВАЖНО: ШАГ 1 - Настройте эти переменные !!
        // -----------------------------------------------------------------
        
        // Вставьте сюда адрес вашего контракта ПОСЛЕ его развертывания в Sepolia
        const CONTRACT_ADDRESS = "0x...ВАШ_АДРЕС_КОНТРАКТА";

        // Вставьте сюда ABI вашего контракта из Remix (вкладка "Compile", кнопка "ABI")
        // Это "описание" функций вашего контракта
        const CONTRACT_ABI = [
            // Пример ABI. Замените его на свой.
            // Это ABI для функций getReviews и addReview
            {
                "inputs": [
                    { "internalType": "string", "name": "_locationId", "type": "string" },
                    { "internalType": "string", "name": "_institutionName", "type": "string" },
                    { "internalType": "string", "name": "_message", "type": "string" },
                    { "internalType": "uint8", "name": "_rating", "type": "uint8" }
                ],
                "name": "addReview",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    { "internalType": "string", "name": "_locationId", "type": "string" }
                ],
                "name": "getReviews",
                "outputs": [
                    {
                        "components": [
                            { "internalType": "address", "name": "user", "type": "address" },
                            { "internalType": "string", "name": "institutionName", "type": "string" },
                            { "internalType": "string", "name": "message", "type": "string" },
                            { "internalType": "uint8", "name": "rating", "type": "uint8" },
                            { "internalType": "uint256", "name": "timestamp", "type": "uint256" }
                        ],
                        "internalType": "struct GeoReviews.Review[]",
                        "name": "",
                        "type": "tuple[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "address", "name": "user", "type": "address" },
                    { "indexed": true, "internalType": "string", "name": "locationId", "type": "string" },
                    { "internalType": "string", "name": "institutionName", "type": "string" },
                    { "internalType": "uint8", "name": "rating", "type": "uint8" }
                ],
                "name": "ReviewAdded",
                "type": "event"
            }
        ];
        // -----------------------------------------------------------------
        
        const SEPOLIA_CHAIN_ID = "0xaa36a7"; // 11155111 в hex

        // Глобальные переменные Web3
        let provider;
        let signer;
        let contract;
        let userAddress;
        
        // Глобальные переменные Карты
        let map;
        let selectedLocationId; // Выбранная локация (строка)
        let mapClickMarker; // Маркер на месте клика

        // DOM Элементы
        const connectButton = document.getElementById('connectButton');
        const walletInfo = document.getElementById('walletInfo');
        const walletAddressElem = document.getElementById('walletAddress');
        const networkNameElem = document.getElementById('networkName');
        const wrongNetworkBanner = document.getElementById('wrongNetworkBanner');
        
        const reviewPanel = document.getElementById('reviewPanel');
        const closePanelButton = document.getElementById('closePanelButton');
        const locationIdDisplay = document.getElementById('locationIdDisplay');
        const reviewsList = document.getElementById('reviewsList');
        const noReviewsMessage = document.getElementById('noReviewsMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');

        const tabView = document.getElementById('tabView');
        const tabAdd = document.getElementById('tabAdd');
        const viewContent = document.getElementById('viewContent');
        const addContent = document.getElementById('addContent');

        const reviewForm = document.getElementById('reviewForm');
        const submitReviewButton = document.getElementById('submitReviewButton');
        const txStatus = document.getElementById('txStatus');

        // --- 1. Логика Web3 (MetaMask и Контракт) ---

        /**
         * Подключение к MetaMask
         */
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('MetaMask не установлен! Пожалуйста, установите расширение MetaMask.');
                return;
            }
            
            if (CONTRACT_ADDRESS === "0x...ВАШ_АДРЕС_КОНТРАКТА") {
                alert("Ошибка: Адрес контракта не указан. Отредактируйте index.html.");
                return;
            }

            try {
                // 1. Запрос на подключение кошелька
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];

                // 2. Инициализация Ethers.js
                // BrowserProvider - это специальный провайдер для работы с MetaMask
                provider = new ethers.BrowserProvider(window.ethereum);
                
                // 3. Проверка сети
                if (await checkNetwork()) {
                    // 4. Получение "подписчика" (Signer) - он нужен для отправки транзакций
                    signer = await provider.getSigner();

                    // 5. Инициализация контракта
                    // Теперь мы можем вызывать функции контракта, как будто это JS-объект
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                    // 6. Обновление UI
                    updateWalletUI(userAddress);
                }

            } catch (error) {
                console.error("Ошибка подключения кошелька:", error);
                alert("Не удалось подключить кошелек.");
            }
        }

        /**
         * Проверка, что пользователь находится в сети Sepolia
         */
        async function checkNetwork() {
            const network = await provider.getNetwork();
            const chainId = `0x${network.chainId.toString(16)}`;

            if (chainId === SEPOLIA_CHAIN_ID) {
                wrongNetworkBanner.classList.add('hidden');
                networkNameElem.textContent = "Sepolia";
                return true;
            } else {
                // Сеть неверная, показываем баннер и просим переключиться
                wrongNetworkBanner.classList.remove('hidden');
                networkNameElem.textContent = "Wrong Network!";
                try {
                    // Пытаемся автоматически переключить сеть
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: SEPOLIA_CHAIN_ID }],
                    });
                    // Если успешно, перезагружаем страницу, чтобы Ethers подхватил новую сеть
                    window.location.reload();
                } catch (switchError) {
                    // Пользователь отклонил переключение
                    console.error("Ошибка переключения сети:", switchError);
                }
                return false;
            }
        }

        /**
         * Обновление UI после подключения кошелька
         */
        function updateWalletUI(address) {
            connectButton.classList.add('hidden');
            walletInfo.classList.remove('hidden');
            // Показываем укороченный адрес
            walletAddressElem.textContent = `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
            
            // Теперь, когда кошелек подключен, разрешаем добавлять отзывы
            tabAdd.disabled = false;
            tabAdd.classList.remove("text-gray-600", "cursor-not-allowed");
            tabAdd.classList.add("text-gray-400");
        }
        
        /**
         * Обработчик смены аккаунта или сети в MetaMask
         */
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', () => window.location.reload());
            window.ethereum.on('chainChanged', () => window.location.reload());
        }

        // --- 2. Логика Карты (Leaflet) ---

        /**
         * Инициализация карты
         */
        function initMap() {
            // Координаты центра (по умолчанию)
            map = L.map('map').setView([42.8746, 74.5698], 13); // Бишкек

            // Добавление слоя OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Слушатель клика по карте
            map.on('click', onMapClick);
            
            // Создаем маркер, который будем перемещать
            mapClickMarker = L.marker([0, 0], { opacity: 0 }).addTo(map);
        }

        /**
         * Обработчик клика по карте
         */
        function onMapClick(e) {
            const { lat, lng } = e.latlng;
            
            // 1. Округляем координаты, как просил пользователь
            selectedLocationId = roundCoordinates(lat, lng);
            locationIdDisplay.textContent = selectedLocationId;
            
            // 2. Перемещаем маркер и делаем его видимым
            mapClickMarker.setLatLng(e.latlng).setOpacity(1);
            
            // 3. Открываем панель отзывов
            openReviewPanel();

            // 4. Загружаем отзывы для этой локации
            fetchReviews(selectedLocationId);
        }
        
        /**
         * Округление координат до 5 знаков
         * 0.8888888 -> "0.88889"
         * Возвращает строку-ключ "lat,lng"
         */
        function roundCoordinates(lat, lng) {
            const roundedLat = lat.toFixed(5);
            const roundedLng = lng.toFixed(5);
            return `${roundedLat},${roundedLng}`;
        }
        
        // --- 3. Логика Панели Отзывов ---

        function openReviewPanel() {
            reviewPanel.classList.remove('translate-y-full');
            // При открытии всегда показываем вкладку "Просмотр"
            showTab('view');
        }

        function closeReviewPanel() {
            reviewPanel.classList.add('translate-y-full');
            // Скрываем маркер при закрытии панели
            mapClickMarker.setOpacity(0);
        }

        function showTab(tabName) {
            if (tabName === 'view') {
                viewContent.classList.remove('hidden');
                addContent.classList.add('hidden');
                tabView.classList.add('text-white', 'border-blue-500');
                tabAdd.classList.remove('text-white', 'border-blue-500');
            } else if (tabName === 'add') {
                // Не даем открыть вкладку "Добавить", если кошелек не подключен
                if (!signer) {
                    alert("Пожалуйста, сначала подключите кошелек MetaMask, чтобы добавить отзыв.");
                    return;
                }
                viewContent.classList.add('hidden');
                addContent.classList.remove('hidden');
                tabAdd.classList.add('text-white', 'border-blue-500');
                tabView.classList.remove('text-white', 'border-blue-500');
            }
        }

        /**
         * Загрузка отзывов из смарт-контракта
         */
        async function fetchReviews(locationId) {
            // Сначала показываем загрузчик и прячем старые отзывы
            reviewsList.innerHTML = '';
            loadingIndicator.classList.remove('hidden');
            noReviewsMessage.classList.add('hidden');
            
            // Пытаемся получить отзывы.
            // Если кошелек не подключен (provider нет), мы все равно можем читать данные!
            // Для этого создадим "read-only" провайдера
            let readProvider = provider;
            if (!readProvider) {
                // Используем публичный RPC-узел Sepolia
                readProvider = new ethers.JsonRpcProvider("https://rpc.sepolia.org");
            }
            
            // "read-only" контракт
            const readContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, readProvider);

            try {
                // Вызываем 'view' функцию - это бесплатно
                const reviews = await readContract.getReviews(locationId);
                
                loadingIndicator.classList.add('hidden');
                displayReviews(reviews);
                
            } catch (error) {
                console.error("Ошибка загрузки отзывов:", error);
                loadingIndicator.classList.add('hidden');
                reviewsList.innerHTML = `<p class="text-red-400 text-center">Не удалось загрузить отзывы. Проверьте консоль.</p>`;
            }
        }

        /**
         * Отображение загруженных отзывов в UI
         */
        function displayReviews(reviews) {
            reviewsList.innerHTML = ''; // Очищаем список
            
            if (reviews.length === 0) {
                noReviewsMessage.classList.remove('hidden');
                return;
            }

            noReviewsMessage.classList.add('hidden');
            
            // Ethers.js возвращает struct как массив.
            // [user, institutionName, message, rating, timestamp]
            
            // Мы получили массив кортежей (tuple), отображаем их
            // Проходим по массиву в обратном порядке, чтобы новые были сверху
            for (let i = reviews.length - 1; i >= 0; i--) {
                const review = reviews[i];
                
                // Данные из struct
                const userAddr = review[0];
                const name = review[1];
                const message = review[2];
                const rating = Number(review[3]); // Преобразуем BigInt/Number в Number
                const timestamp = Number(review[4]); //
                
                const date = new Date(timestamp * 1000).toLocaleString();
                const shortAddr = `${userAddr.substring(0, 6)}...${userAddr.substring(userAddr.length - 4)}`;
                const stars = '★'.repeat(rating) + '☆'.repeat(5 - rating);

                const reviewElement = document.createElement('div');
                reviewElement.className = 'bg-gray-800 p-4 rounded-lg shadow-md border border-gray-700';
                reviewElement.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-semibold text-white">${name}</h4>
                        <span class="text-yellow-400 font-bold">${stars}</span>
                    </div>
                    <p class="text-gray-300 mb-3">${message}</p>
                    <div class="flex justify-between items-center text-xs text-gray-500">
                        <span>От: <span class="font-mono">${shortAddr}</span></span>
                        <span>${date}</span>
                    </div>
                `;
                reviewsList.appendChild(reviewElement);
            }
        }


        /**
         * Отправка отзыва в блокчейн
         */
        async function handleSubmitReview(e) {
            e.preventDefault(); // Предотвращаем перезагрузку страницы
            
            if (!contract || !signer) {
                alert("Кошелек не подключен или контракт не инициализирован.");
                return;
            }

            const institutionName = document.getElementById('institutionName').value;
            const message = document.getElementById('message').value;
            const rating = document.getElementById('rating').value;

            // Блокируем кнопку
            submitReviewButton.disabled = true;
            submitReviewButton.textContent = "Подтвердите в MetaMask...";
            txStatus.classList.remove('hidden', 'text-green-400', 'text-red-400');
            txStatus.classList.add('text-yellow-400');
            txStatus.textContent = "Ожидание подписи транзакции...";

            try {
                // 1. Вызываем функцию контракта. Это вернет объект транзакции (tx)
                // Это "write" функция, она требует подписи и тратит газ
                const tx = await contract.addReview(
                    selectedLocationId,
                    institutionName,
                    message,
                    rating
                );

                txStatus.textContent = "Транзакция отправлена... Ожидание майнинга...";
                txStatus.classList.replace('text-yellow-400', 'text-blue-400');

                // 2. Ждем, пока транзакция будет включена в блок (замайнена)
                await tx.wait();

                // 3. Успех!
                txStatus.textContent = "Отзыв успешно добавлен в блокчейн!";
                txStatus.classList.replace('text-blue-400', 'text-green-400');
                
                // Сбрасываем форму
                reviewForm.reset();
                
                // Переключаемся на вкладку "Просмотр" и обновляем отзывы
                setTimeout(() => {
                    showTab('view');
                    fetchReviews(selectedLocationId); // Перезагружаем отзывы
                    txStatus.classList.add('hidden');
                }, 2000);

            } catch (error) {
                console.error("Ошибка отправки отзыва:", error);
                txStatus.textContent = `Ошибка: ${error.message.substring(0, 50)}...`;
                txStatus.classList.replace('text-yellow-400', 'text-red-400');
            } finally {
                // Разблокируем кнопку в любом случае
                submitReviewButton.disabled = false;
                submitReviewButton.textContent = "Отправить отзыв (потребует Gas)";
            }
        }

        // --- 4. Инициализация и Слушатели ---

        // Слушатели для панели
        closePanelButton.addEventListener('click', closeReviewPanel);
        tabView.addEventListener('click', () => showTab('view'));
        tabAdd.addEventListener('click', () => showTab('add'));

        // Слушатель для кнопки "Подключить"
        connectButton.addEventListener('click', connectWallet);
        
        // Слушатель для формы
        reviewForm.addEventListener('submit', handleSubmitReview);

        // Запускаем приложение
        initMap();
        
        // При загрузке страницы, отключаем вкладку "Добавить", пока не подключен кошелек
        tabAdd.disabled = true;
        tabAdd.classList.add("text-gray-600", "cursor-not-allowed");

    </script>
</body>
</html>
